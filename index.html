<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>さとるゲーム</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/addons/p5.sound.min.js"></script>
  <style>
    /* ★変更点2：touch-action: none でスクロールや長押しメニューを禁止 */
    body { 
      margin: 0; 
      padding: 0; 
      overflow: hidden; 
      background: #f0f0f0; 
      touch-action: none; 
      user-select: none; /* 文字選択も防ぐ */
      -webkit-user-select: none;
    }
    canvas { display: block; }
  </style>
</head>
<body>
<script>
  let targets = []; 
  let score = 0;
  let highScore = 0; 
  
  // スマホだと少し難しすぎるかもしれないので、
  // PCより少しだけ優しくするか、そのままにするかはお好みで！
  let spawnRate = 20; 
  
  let gameTime = 30; 
  let timeLeft;      
  
  let isGameStarted = false; 
  let isGameOver = false;    
  let isNewRecord = false; 

  let hitSound;
  let finishSound;
  let targetImg; 

  let btnW = 240;
  let btnH = 70;

  function preload() {
    soundFormats('mp3', 'ogg');
    hitSound = loadSound('hit.mp3');
    finishSound = loadSound('finish.mp3');
    targetImg = loadImage('kawamura.png'); 
  }

  function setup() {
    createCanvas(windowWidth, windowHeight);
    textAlign(CENTER, CENTER);
    
    let savedScore = localStorage.getItem("satoruGameHighScore");
    if (savedScore !== null) {
      highScore = parseInt(savedScore); 
    }
    
    if(hitSound) hitSound.setVolume(0.5);
    if(finishSound) finishSound.setVolume(0.5);
  }

  // ★変更点3：スマホを回転させた時に画面サイズを直す
  function windowResized() {
    resizeCanvas(windowWidth, windowHeight);
  }

  function draw() {
    background(240); 

    if (!isGameStarted) {
      drawStartScreen();
    } else if (!isGameOver) {
      playGame();
    } else {
      drawGameOver();
    }
  }

  function drawStartScreen() {
    fill(0);
    // スマホだと文字が大きすぎることがあるので、少し調整
    textSize(min(48, width / 8)); 
    text("さとるゲーム", width / 2, height / 2 - 80);
    
    textSize(20);
    text("High Score: " + highScore, width / 2, height / 2 - 20);

    let btnX = width / 2 - btnW / 2;
    let btnY = height / 2 + 50;
    drawButton("GAME START", btnX, btnY, btnW, btnH);
  }

  function drawGameOver() {
    if (isNewRecord) {
      fill(255, 200, 0); 
      textSize(min(40, width / 10));
      text("✨ NEW RECORD! ✨", width / 2, height / 2 - 120);
    } else {
      fill(0); 
      textSize(64);
      text("FINISH", width / 2, height / 2 - 100);
    }
    
    fill(0);
    textSize(32);
    text("Score: " + score, width / 2, height / 2 - 20);
    
    fill(100);
    textSize(20);
    text("Best: " + highScore, width / 2, height / 2 + 30);
    
    let btnX = width / 2 - btnW / 2;
    let btnY = height / 2 + 80;
    drawButton("RETRY", btnX, btnY, btnW, btnH);
  }

  function drawButton(label, x, y, w, h) {
    fill(180); 
    noStroke();
    rect(x + 5, y + 5, w, h, 20); 

    fill(0, 120, 255);
    rect(x, y, w, h, 20);

    fill(255);
    textSize(28);
    text(label, x + w / 2, y + h / 2);
  }

  function playGame() {
    if (frameCount % 60 === 0 && timeLeft > 0) {
      timeLeft--;
    }
    
    if (timeLeft === 0) {
      gameOverProcess(); 
    }

    fill(0);
    textAlign(LEFT, TOP);
    textSize(32);
    text("Score: " + score, 20, 20);
    
    textSize(20);
    fill(100);
    text("High Score: " + highScore, 20, 100);

    textSize(32);
    fill(0);
    if (timeLeft <= 5) fill(255, 0, 0); 
    text("Time: " + timeLeft, 20, 60);
    
    if (frameCount % spawnRate === 0) {
      targets.push(new Target());
    }

    for (let i = targets.length - 1; i >= 0; i--) {
      let k = targets[i];
      k.move();
      k.display();

      if (k.y > height + 50) {
        targets.splice(i, 1);
      }
      if (k.isHit && k.life <= 0) {
         targets.splice(i, 1);
      }
    }
  }

  function gameOverProcess() {
    isGameOver = true;
    if (finishSound && finishSound.isLoaded()) finishSound.play();

    if (score > highScore) {
      highScore = score;
      isNewRecord = true;
      localStorage.setItem("satoruGameHighScore", highScore);
    }
  }

  function resetGame() {
    score = 0;
    timeLeft = gameTime;
    targets = [];
    isGameOver = false;
    isNewRecord = false; 
    frameCount = 0; 
  }

  function mousePressed() {
    // タッチした瞬間もmousePressedとして判定されます
    userStartAudio();

    // ★スマホでの誤操作を防ぐため、クリック位置を厳密にチェック
    // タッチ座標がちゃんと画面内にあるか？
    if (mouseX < 0 || mouseX > width || mouseY < 0 || mouseY > height) {
        return;
    }

    let w = btnW;
    let h = btnH;

    if (!isGameStarted) {
      let x = width / 2 - w / 2;
      let y = height / 2 + 50; 

      if (mouseX > x && mouseX < x + w && mouseY > y && mouseY < y + h) {
        isGameStarted = true;
        resetGame();
      }

    } else if (isGameOver) {
      let x = width / 2 - w / 2;
      let y = height / 2 + 80; 

      if (mouseX > x && mouseX < x + w && mouseY > y && mouseY < y + h) {
        resetGame();
      }

    } else {
      for (let k of targets) {
        k.checkHit(mouseX, mouseY);
      }
    }
    
    // ブラウザ標準のタッチ動作（拡大など）を無効化
    return false;
  }

  class Target {
    constructor() {
      this.r = 40; 
      this.x = random(this.r, width - this.r);
      this.y = -50;
      this.speed = random(6, 12); 
      this.isHit = false; 
      this.life = 30; 
    }

    move() {
      if (!this.isHit) {
        this.y += this.speed;
      } else {
        this.y -= 1; 
        this.life--;
      }
    }

    display() {
      textAlign(CENTER, CENTER);
      if (this.isHit) {
        textSize(this.r * 2);
        text("❤️", this.x, this.y);
      } else {
        imageMode(CENTER);
        image(targetImg, this.x, this.y, this.r * 2, this.r * 2);

        fill(0);       
        noStroke();    
        textSize(16);  
        text("さとる", this.x, this.y - this.r - 15);
      }
    }

    checkHit(mx, my) {
      if (this.isHit) return;
      let d = dist(mx, my, this.x, this.y);
      if (d < this.r) {
        this.isHit = true;
        score += 100; 
        
        if (hitSound && hitSound.isLoaded()) {
          hitSound.play();
        }
      }
    }
  }
</script>
</body>
</html>
